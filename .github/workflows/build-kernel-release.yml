  build-kernel:
    name: Build ${{ matrix.model }} NetHunter Kernel
    needs: set-op-model
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.set-op-model.outputs.matrix) }}
    steps:
      # ---------------------------------------------------------
      # â˜¢ï¸ 1. STORAGE NUKE (Space Bachao)
      # ---------------------------------------------------------
      - name: â˜¢ï¸ Storage Nuke (Free Disk Space)
        run: |
          echo "Freeing up disk space..."
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          sudo apt-get autoremove -y

      # ---------------------------------------------------------
      # 2. CHECKOUT CODE
      # ---------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ---------------------------------------------------------
      # ðŸ› ï¸ 3. INSTALL TOOLS (Manual Setup)
      # ---------------------------------------------------------
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 python3-pip clang lld llvm

      # ---------------------------------------------------------
      # ðŸ›¡ï¸ 4. FIX SOURCE ERRORS
      # ---------------------------------------------------------
            - name: Fix Source Code Errors & Inject NetHunter
        run: |
          echo "ðŸ›¡ï¸ Fixing stack_pointer and kgdb..."
          find . -name stack_pointer.h -exec sed -i 's/register unsigned long current_stack_pointer asm ("sp");/register unsigned long current_stack_pointer;/' {} +
          find . -name kgdb.h -exec sed -i 's/asm ("brk %0" : : "I" (KGDB_COMPILED_DBG_BRK_IMM));/\/\/ asm ("brk %0" : : "I" (KGDB_COMPILED_DBG_BRK_IMM));/' {} +

          echo "ðŸ’‰ Injecting NetHunter Features (Built-in = y)..."
          # Hum saare config files me NetHunter features append kar rahe hain
          find arch/arm64/configs/vendor -name "*gki.config" -o -name "*defconfig" | while read config_file; do
            echo "Patching $config_file..."
            echo "CONFIG_USB_CONFIGFS_F_HID=y" >> "$config_file"
            echo "CONFIG_USB_CONFIGFS_F_ACC=y" >> "$config_file"
            echo "CONFIG_USB_CONFIGFS_UEVENT=y" >> "$config_file"
            echo "CONFIG_MAC80211=y" >> "$config_file"
            echo "CONFIG_MAC80211_LEDS=y" >> "$config_file"
            echo "CONFIG_MAC80211_MESH=y" >> "$config_file"
            echo "CONFIG_CDROM=y" >> "$config_file"
            echo "CONFIG_IP_SET=y" >> "$config_file"
            echo "CONFIG_NETFILTER_XT_TARGET_HL=y" >> "$config_file"
            echo "CONFIG_NETFILTER_XT_MATCH_HL=y" >> "$config_file"
            # RTL8188EU Driver (Staging)
            echo "CONFIG_STAGING=y" >> "$config_file"
            echo "CONFIG_R8188EU=y" >> "$config_file"
            echo "CONFIG_RTL8188EU=y" >> "$config_file"
          done

      # ---------------------------------------------------------
      # ðŸ’‰ 5. CONFIGURE & INJECT NETHUNTER (The Magic Step)
      # ---------------------------------------------------------
      - name: Configure and Inject NetHunter Features
        run: |
          # Pehle Default Config Generate karo (Assuming defconfig is setup via previous steps or default)
          # Note: Agar specific defconfig chahiye, toh yahan 'make ... defconfig' command add karna padega.
          # Filhal hum 'olddefconfig' use kar rahe hain jo existing .config ya default use karega.
          
          # Environment Variables
          export ARCH=arm64
          export CC=clang
          export LLVM=1
          
          make O=out olddefconfig

          echo "ðŸ’‰ Injecting NetHunter Features into Kernel Image..."
          cd out
          
          # --- NetHunter HID, WiFi Injection & CDROM ---
          ../scripts/config --file .config \
              --enable CONFIG_USB_CONFIGFS_F_HID \
              --enable CONFIG_USB_CONFIGFS_F_ACC \
              --enable CONFIG_USB_CONFIGFS_UEVENT \
              --enable CONFIG_MAC80211 \
              --enable CONFIG_MAC80211_LEDS \
              --enable CONFIG_MAC80211_MESH \
              --enable CONFIG_CDROM

          # --- RTL8188EU Driver (Built-in) ---
          ../scripts/config --file .config \
              --enable CONFIG_STAGING \
              --enable CONFIG_R8188EU \
              --enable CONFIG_RTL8188EU 

          # --- IP Set & TTL ---
          ../scripts/config --file .config \
              --enable CONFIG_IP_SET \
              --enable CONFIG_NETFILTER_XT_TARGET_HL \
              --enable CONFIG_NETFILTER_XT_MATCH_HL

          # --- Branding ---
          ../scripts/config --file .config --set-str CONFIG_LOCALVERSION "-NetHunter-Jinn"
          cd ..

      # ---------------------------------------------------------
      # ðŸ”¥ 6. BUILD KERNEL IMAGE (No Modules Job Needed)
      # ---------------------------------------------------------
      - name: Build Kernel Image
        run: |
          export ARCH=arm64
          export CC=clang
          export LLVM=1
          export LLVM_IAS=1
          
          make -j$(nproc --all) O=out \
              KCFLAGS="-Wno-error -Wno-unused-variable -Wno-frame-larger-than=" \
              Image

      # ---------------------------------------------------------
      # ðŸ“¤ 7. UPLOAD ARTIFACT (Download karne ke liye)
      # ---------------------------------------------------------
      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: Image-${{ matrix.model }}
          path: out/arch/arm64/boot/Image
          
