  build-kernel:
    name: Build ${{ matrix.model }} NetHunter Kernel
    needs: set-op-model
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.set-op-model.outputs.matrix) }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      # üëá SHIELDS (Ye zaroori hai taaki error na aaye)
      KCFLAGS: "-Wno-error -Wno-unused-variable -Wno-frame-larger-than= -Wno-single-bit-bitfield-constant-conversion"

    steps:
      # ---------------------------------------------------------
      # ‚ò¢Ô∏è 1. STORAGE NUKE (Space Bachao)
      # ---------------------------------------------------------
      - name: ‚ò¢Ô∏è Storage Nuke (Free Disk Space)
        run: |
          echo "Freeing up disk space..."
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          sudo apt-get autoremove -y

      # ---------------------------------------------------------
      # 2. CHECKOUT CODE
      # ---------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ---------------------------------------------------------
      # üõ†Ô∏è 3. INSTALL TOOLS (Manual Setup)
      # ---------------------------------------------------------
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 python3-pip clang lld llvm

      # ---------------------------------------------------------
      # üõ°Ô∏è 4. FIX SOURCE ERRORS (Indentation Fixed)
      # ---------------------------------------------------------
      - name: Fix Source Code Errors
        run: |
          echo "üõ°Ô∏è Fixing stack_pointer and kgdb..."
          find . -name stack_pointer.h -exec sed -i 's/register unsigned long current_stack_pointer asm ("sp");/register unsigned long current_stack_pointer;/' {} +
          find . -name kgdb.h -exec sed -i 's/asm ("brk %0" : : "I" (KGDB_COMPILED_DBG_BRK_IMM));/\/\/ asm ("brk %0" : : "I" (KGDB_COMPILED_DBG_BRK_IMM));/' {} +

      # ---------------------------------------------------------
      # üíâ 5. CONFIGURE & INJECT NETHUNTER (Correct Logic)
      # ---------------------------------------------------------
      - name: Configure and Inject NetHunter Features
        run: |
          # Environment Variables Set karo
          export ARCH=arm64
          export CC=clang
          export LLVM=1
          
          # Pehle Base Config Generate karo
          make O=out olddefconfig

          echo "üíâ Injecting NetHunter Features into Kernel Image..."
          cd out
          
          # --- NetHunter HID, WiFi Injection & CDROM ---
          ../scripts/config --file .config \
              --enable CONFIG_USB_CONFIGFS_F_HID \
              --enable CONFIG_USB_CONFIGFS_F_ACC \
              --enable CONFIG_USB_CONFIGFS_UEVENT \
              --enable CONFIG_MAC80211 \
              --enable CONFIG_MAC80211_LEDS \
              --enable CONFIG_MAC80211_MESH \
              --enable CONFIG_CDROM

          # --- RTL8188EU Driver (Built-in) ---
          ../scripts/config --file .config \
              --enable CONFIG_STAGING \
              --enable CONFIG_R8188EU \
              --enable CONFIG_RTL8188EU 

          # --- IP Set & TTL ---
          ../scripts/config --file .config \
              --enable CONFIG_IP_SET \
              --enable CONFIG_NETFILTER_XT_TARGET_HL \
              --enable CONFIG_NETFILTER_XT_MATCH_HL

          # --- Branding ---
          ../scripts/config --file .config --set-str CONFIG_LOCALVERSION "-NetHunter-Jinn"
          cd ..

      # ---------------------------------------------------------
      # üî• 6. BUILD KERNEL IMAGE (Ye Missing tha!)
      # ---------------------------------------------------------
      - name: Build Kernel Image
        run: |
          export ARCH=arm64
          export CC=clang
          export LLVM=1
          export LLVM_IAS=1
          
          # Sirf Image bana rahe hain (Modules built-in ho gaye)
          make -j$(nproc --all) O=out Image

      # ---------------------------------------------------------
      # üì§ 7. UPLOAD ARTIFACT (Ye bhi zaroori hai)
      # ---------------------------------------------------------
      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: Image-${{ matrix.model }}
          path: out/arch/arm64/boot/Image
          
